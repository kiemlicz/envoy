{% from "_common/util.jinja" import is_docker with context %}

{% macro redis_master_id(ip, port, container_id=None) -%}
{% if container_id is defined -%}
{{ salt['docker.run'](container_id, 'redis-cli -h ' + ip + ' -p ' + port|string + ' CLUSTER MYID') }}
{% else -%}
{{ salt['cmd.run']('redis-cli -h ' + ip + ' -p ' + port|string + ' CLUSTER MYID') }}
{% endif -%}
{%- endmacro %}

{% macro redis_configure(redis, bind, instance_number, service) -%}

redis_config_{{ bind.ip }}_{{ bind.port }}:
  file_ext.managed:
    - name: /etc/redis/redis-{{ instance_number }}.conf
    - source: {{ redis.config.source }}
    - makedirs: True
    - template: jinja
    - context:
      bind: {{ bind|json_decode_dict }}
      redis:
        daemonize: {{ redis.daemonize }}
        setup_type: {{ redis.setup_type }}
        config:
          dir: {{ redis.config.dir }}-{{ instance_number }}
          pid: "/var/run/redis-" ~ {{ instance_number }} ~ "/redis-server.pid"
    - require:
      - file_ext: {{ redis.config.init_location }}
{% if salt['grains.get']("init") != 'systemd' %}
  file.symlink:
    - name: /etc/init.d/redis-server-{{ instance_number }}
    - target: {{ redis.config.init_location }}
    - require:
      - file_ext: /etc/redis/redis-{{ instance_number }}.conf
    - watch_in:
      - service: {{ service }}
{% endif %}
  service.running:
    - name: {{ service }}
{% if not is_docker() %}
    - enable: True
{% endif %}
    - watch:
      - file_ext: /etc/redis/redis-server-{{ instance_number }}.conf
{%- endmacro %}

{% macro minion_pods(pod_function_name, minion=grains['id']) -%}
salt['mine.get'](tgt=minion, fun=pod_function_name)[minion]
{%- endmacro %}


{% macro pod_ip(mine_data, minion=grains['id']) -%}
  {% do salt.log.error("dane = {}".format(mine_data)) %}
  {% set container_envs = mine_data[minion]['Config']['Env'] %}
  {{  (salt.filters.find(container_envs, "POD_IP=\d+\.\d+\.\d+\.\d+")|first).split("=")[1] }}
{%- endmacro %}
