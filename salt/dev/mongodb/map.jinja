{% import_yaml "defaults.yaml" as defaults %}


{% set setup_type = salt['pillar.get']('mongodb:setup_type', default=defaults.mongodb.setup_type) %}

{# extract IP field, map to list, otherwise this will be the Generator object #}
{# todo |default(...) didn't work, why? #}
{% set interfaces = salt['pillar.get']('foreman_interfaces')|map(attribute='ip')|list %}
{% if not interfaces %}
{% set interfaces = salt['pillar.get']('mongodb:settings:interfaces', default=defaults.mongodb.settings.interfaces) %}
{% else %}
{% do interfaces.append("127.0.0.1") %}
{% endif %}
{% set port = salt['pillar.get']('mongodb:settings:port', default=defaults.mongodb.settings.port) %}

{% set mongodb_repo = salt['grains.filter_by']({
    'Debian': {
        'repo_entries': [
          "deb http://repo.mongodb.org/apt/debian jessie/mongodb-org/3.4 main"
        ],
        'file': '/etc/apt/sources.list.d/mongodb-org-3.4.list',
    },
    'Ubuntu': {
        'repo_entries': [
          "deb [ arch=amd64,arm64 ] http://repo.mongodb.org/apt/ubuntu xenial/mongodb-org/3.4 multiverse"
        ],
        'file': '/etc/apt/sources.list.d/mongodb-org-3.4.list',
    }
}, grain='oscodename', merge=salt['pillar.get']('mongodb:repo', default=defaults.mongodb.repo, merge=True)) %}

{# todo verify mongodb docker requisites are still needed #}

{% set mongodb_docker = salt['grains.filter_by']({
    'default': {
        'bind_addresses': interfaces,
        'bind_port': port,
        'prerequisites': ['python-pip'],
        'pip_pkgs': ['docker-py']
    },
}, merge=salt['pillar.get']('mongodb:docker', default=defaults.mongodb.docker, merge=True)) %}
