{%- from "_common/conf.jinja" import k_v,p_blocklist,p_blockdict with context -%}
{%- for addr, params in keepalived.get("virtual_servers", {}).items() %}
virtual_server {{ addr }} {
{% for p in params.keys() %}
{%- if params[p]|is_list -%}
    {{ p_blocklist(p, params)|indent(4,True) }}
{%- elif params[p] is mapping -%}
    {{ p_blockdict(p, params, params[p].keys())|indent(4,True) }}
{%- else -%}
    {{ k_v(p, params)|indent(4,True) }}
{%- endif %}
{% endfor %}
{% for addr,params in keepalived.get("real_servers", {}).items()|...todo filter by port %}
{% endfor %}
}
{% endfor %}
